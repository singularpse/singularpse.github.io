var kShowControllerState_Stopped="Stopped";var kShowControllerState_Starting="Starting";var kShowControllerState_DownloadingScript="DownloadingScipt";var kShowControllerState_SettingUpScene="SettingUpScene";var kShowControllerState_IdleAtFinalState="IdleAtFinalState";var kShowControllerState_IdleAtInitialState="IdleAtInitialState";var kShowControllerState_WaitingToJump="WaitingToJump";var kShowControllerState_ReadyToJump="ReadyToJump";var kShowControllerState_WaitingToDisplay="WaitingToDisplay";var kShowControllerState_ReadyToDisplay="ReadyToDisplay";var kShowControllerState_WaitingToPlay="WaitingToPlay";var kShowControllerState_ReadyToPlay="ReadyToPlay";var kShowControllerState_Playing="Playing";var kKeyDownEvent="keydown";var kSlideIndexDidChangeEvent="ShowController:SlideIndexDidChangeEvent";var ShowController=Class.create({initialize:function(){this.delegate=extractDelegateFromUrlParameter();this.delegate.showDidLoad();this.showUrl="../";this.displayManager=new DisplayManager();this.scriptManager=new ScriptManager(this.showUrl);this.textureManager=new TextureManager(this.showUrl);this.stageManager=new StageManager(this.textureManager,this.scriptManager);this.touchController=new TouchController();this.animationManager=new AnimationManager();this.orientationController=new OrientationController();this.activeHyperlinks=new Array();this.movieHyperlinks=new Array();this.script=null;this.currentSceneIndex=-1;this.nextSceneIndex=-1;this.currentSlideIndex=-1;this.previousSlideIndex=-1;this.currentSoundTrackIndex=0;this.transformOriginValue="";this.accumulatingDigits=false;this.digitAccumulator=0;this.firstSlide=true;this.lastSlideViewedIndex=-1;this.accountID="";this.guid="";this.locale="EN";this.isNavigationBarVisible=false;this.isFullscreen=false;this.volume=3;this.muted=false;this.soundTrackPlayer=null;this.sceneIndexOfPrebuiltAnimations=-1;this.queuedUserAction=null;document.observe(kScriptDidDownloadEvent,this.handleScriptDidDownloadEvent.bind(this));document.observe(kScriptDidNotDownloadEvent,this.handleScriptDidNotDownloadEvent.bind(this));document.observe(kStageIsReadyEvent,this.handleStageIsReadyEvent.bind(this));document.observe(kStageSizeDidChangeEvent,this.handleStageSizeDidChangeEvent.bind(this));document.observe(kKeyDownEvent,this.handleKeyDownEvent.bind(this));document.observe(kSwipeEvent,this.handleSwipeEvent.bind(this));Event.observe(this.displayManager.body,"click",this.handleClickEvent.bind(this));document.observe(kFullscreenChangeEventName,this.handleFullscreenChangeEvent.bind(this));Event.observe(window,"resize",this.handleWindowResizeEvent.bind(this));this.touchController.registerTapEventCallback(this.handleTapEvent.bind(this));this.changeState(kShowControllerState_Stopped);this.movieCache=null;this.audioCache=null;this.playbackController=new KPFPlaybackController({},this.stageManager.stage);this.navigatorController=new NavigatorController(document.getElementById("slideshowNavigator"));this.slideNumberController=new SlideNumberController(document.getElementById("slideNumberControl"));this.slideNumberDisplay=new SlideNumberDisplay(document.getElementById("slideNumberDisplay"));this.helpPlacard=new HelpPlacardController(document.getElementById("helpPlacard"));this.isRecording=false;this.isRecordingStarted=false;if(isIE&&browserVersion<10){this.animationsupported=false}else{this.animationsupported=true}document.observe("contextmenu",this.handlecontextmenuevent.bind(this));event.observe(this.displaymanager.previousbutton,"click",this.gobacktopreviousslide.bind(this,"tappreviousbutton"));event.observe(this.displaymanager.nextbutton,"click",this.advancetonextbuild.bind(this,"tapnextbutton"))},startshow:function(){this.changestate(kshowcontrollerstate_downloadingscript);this.scriptmanager.downloadscript(this.delegate)},exitshow:function(a){cleartimeout(this.exittimeout);if(a){this.delegate.showexited()}else{this.exittimeout=settimeout((function(){this.delegate.showexited()}).bind(this),750)}},promptusertotryagain:function(b){var a="false;a=confirm(b);return" a},handlescriptdiddownloadevent:function(b){switch(this.state){case="" kshowcontrollerstate_downloadingscript:var="" g="this.script=b.memo.script;var" d="g.showMode;if(d==kShowModeHyperlinksOnly){this.displayManager.setHyperlinksOnlyMode()}this.changeState(kShowControllerState_Starting);var" h;var="" c="parseInt(getUrlParameter("restartingSceneIndex"));var" i="document.URL.split("?");var" f="i[0].split("#");if(f[1]){c=parseInt(f[1])}if(c){h=c}else{var" j="getUrlParameter("currentSlide");var" a;if(j){a="parseInt(j)}else{a=1}h=this.scriptManager.sceneIndexFromSlideIndex(a-1)}if(g.recording){if(g.recording.eventTracks[0].type==="navigation"){this.narrationManager=new" narrationmanager(g.recording);h="this.narrationManager.sceneIndexFromNavigationEvent(this.narrationManager.navigationEvents[0]);this.isRecording=true;this.jumpToScene(h,false);break}}if(h">g.lastSceneIndex){break}if(d===kShowModeAutoplay){this.jumpToScene(h,true)}else{var b=g.events[h];var e=b.automaticPlay==1||b.automaticPlay==true;this.jumpToScene(h,e)}break;default:debugMessage(kDebugShowController_HandleScriptDidDownloadEvent,"- hmmm we seem to have arrived here from an unpredicted state");break}},handleScriptDidNotDownloadEvent:function(b){debugMessage(kDebugShowController_HandleScriptDidNotDownloadEvent);var a=this.promptUserToTryAgain(kUnableToReachiWorkTryAgain);if(a){this.scriptManager.downloadScript()}else{this.displayManager.clearLaunchMode();this.displayManager.hideWaitingIndicator()}},handleStageIsReadyEvent:function(a){if(this.isFullscreen){setTimeout((function(){this.displayManager.stageArea.style.opacity=1}).bind(this),50)}else{setTimeout((function(){this.displayManager.stageArea.style.opacity=1}).bind(this),500)}this.positionSlideNumberControl();this.positionSlideNumberDisplay();this.positionHelpPlacard()},positionSlideNumberControl:function(){var b=(this.displayManager.usableDisplayWidth-this.slideNumberController.width)/2;var a=this.displayManager.stageAreaTop+this.displayManager.stageAreaHeight-(this.slideNumberController.height+16);this.slideNumberController.setPosition(b,a)},positionSlideNumberDisplay:function(){var b=(this.displayManager.usableDisplayWidth-this.slideNumberDisplay.width)/2;var a=this.displayManager.stageAreaTop+this.displayManager.stageAreaHeight-(this.slideNumberDisplay.height+16);this.slideNumberDisplay.setPosition(b,a)},positionHelpPlacard:function(){var b=(this.displayManager.usableDisplayWidth-this.helpPlacard.width)/2;var a=(this.displayManager.usableDisplayHeight-this.helpPlacard.height)/2;this.helpPlacard.setPosition(b,a)},handleFullscreenChangeEvent:function(){if(document.webkitIsFullScreen||document.mozFullScreen){this.isFullscreen=true}else{this.isFullscreen=false}setTimeout((function(){this.displayManager.layoutDisplay()}).bind(this),0)},handleWindowResizeEvent:function(){clearTimeout(this.resizeTimer);this.resizeTimer=setTimeout(this.changeWindowSize.bind(this),1000)},changeWindowSize:function(){if(this.delegate.setViewScale){this.scriptManager.reapplyScaleFactor();this.textureManager.slideCache=null;this.textureManager.slideCache={};var a=this.currentSceneIndex;if(this.state===kShowControllerState_IdleAtFinalState){if(this.currentSceneIndex<this.script.numscenes-1){a=this.currentsceneindex+1}else{if(this.script.loopslideshow){a=0}}}this.jumptoscene(a,false)}document.fire(kshowsizedidchangeevent,{width:this.script.slidewidth,height:this.script.slideheight})},handlestagesizedidchangeevent:function(a){this.touchcontroller.settrackarea(a.memo.left,a.memo.top,a.memo.width,a.memo.height)},handlekeydownevent:function(c){var b="c.charCode||c.keyCode;if(b===kKeyCode_F11||b===kKeyCode_F12){return}var" a="{altKey:!!c.altKey,ctrlKey:!!c.ctrlKey,shiftKey:!!c.shiftKey,metaKey:!!c.metaKey};if(a.metaKey){if(b===kKeyCode_Period||b===kKeyCode_Dot){this.exitShow(true)}else{if(b!=kKeyCode_Return){return}}}else{if(a.ctrlKey){return}}c.stop();this.onKeyPress(b,a)},handleContextMenuEvent:function(a){a.stop()},handleClickEvent:function(b){if(this.isRecording){return}var" a,d;if(b.pagex||b.pagey){a="b.pageX;d=b.pageY}else{a=b.clientX;d=b.clientY}var" c="{pointX:a,pointY:d};if(isIE){window.focus()}if(b.target.nodeName.toLowerCase()==="video"){return}this.processClickOrTapAtDisplayCoOrds(c)},handleTapEvent:function(a){var" d;if(this.slidenumbercontroller.isshowing){if(this.slidenumbertimeout){cleartimeout(this.slidenumbertimeout)}this.slidenumbertimeout="setTimeout(this.hideAndResetSlideNumberController.bind(this),0);return}if(this.helpPlacard.isShowing){this.helpPlacard.hide();return}var" 1:this.advancetonextbuild("handleswipeevent");break;case="" 2:this.advancetonextslide("handleswipeevent");break;default:break}}else{if(a.memo.direction="=="right"){switch(a.memo.fingers){case" 1:this.gobacktopreviousslide("handleswipeevent");break;case="" 2:this.gobacktopreviousbuild("handleswipeevent");break;default:break}}}},onmousedown:function(a){if(a.leftclick){this.advancetonextbuild("onmousedown")}else{if(a.rightclick){this.gobacktopreviousbuild("onmousedown")}}},onkeypress:function(c,a){if((c="">=kKeyCode_Numeric_0)&&(c<=kkeycode_numeric_9)){c=kkeycode_0+(c-kkeycode_numeric_0)}c+=(a.shiftkey?kkeymodifier_shift:0);c+=(a.altkey?kkeymodifier_alt:0);c+=(a.ctrlkey?kkeymodifier_ctrl:0);c+=(a.metakey?kkeymodifier_meta:0);if(this.isrecording){return}var b="false;switch(c){case" kkeycode_escape:this.exitshow(true);break;case="" kkeycode_slash:case="" kkeycode_slash+kkeymodifier_shift:if(this.helpplacard.isshowing){this.helpplacard.hide()}else{this.helpplacard.show()}break;case="" kkeycode_q:this.exitshow(true);break;case="" kkeycode_s:if(this.slidenumbercontroller.isshowing){if(this.slidenumbertimeout){cleartimeout(this.slidenumbertimeout)}this.slidenumbertimeout="setTimeout(this.hideAndResetSlideNumberController.bind(this),0)}if(this.slideNumberDisplay.isShowing){this.slideNumberDisplay.hide()}else{this.slideNumberDisplay.setSlideNumber(this.currentSlideIndex+1);this.slideNumberDisplay.show()}break;case" kkeycode_return:if(this.accumulatingdigits){this.accumulatingdigits="false;if(this.script.showMode!=kShowModeHyperlinksOnly){if(this.digitAccumulator">this.script.slideCount){this.digitAccumulator=this.script.slideCount}else{if(this.digitAccumulator<1){this.digitaccumulator=1}}this.slidenumbercontroller.setslidenumber(this.digitaccumulator);this.jumptoslide(this.digitaccumulator)}else{debugmessage(kdebugshowcontroller_onkeypress,"- can't="" do="" it,="" we're="" in="" hyperlinks="" only="" mode")}break}case="" kkeycode_n:case="" kkeycode_space:case="" kkeycode_downarrow:case="" kkeycode_rightarrow:case="" kkeycode_pagedown:case="" kkeycode_rightarrow+kkeymodifier_shift:this.advancetonextbuild("onkeypress");break;case="" kkeycode_downarrow+kkeymodifier_shift:case="" kkeycode_pagedown+kkeymodifier_shift:case="" kkeycode_closebracket:case="" kkeycode_equal+kkeymodifier_shift:case="" kkeycode_equal:case="" kkeycode_plus:this.advancetonextslide("onkeypress");break;case="" kkeycode_leftarrow+kkeymodifier_shift:case="" kkeycode_pageup+kkeymodifier_shift:case="" kkeycode_openbracket:this.gobacktopreviousbuild("onkeypress");break;case="" kkeycode_p:case="" kkeycode_pageup:case="" kkeycode_leftarrow:case="" kkeycode_uparrow:case="" kkeycode_uparrow+kkeymodifier_shift:case="" kkeycode_hyphen:case="" kkeycode_minus:this.gobacktopreviousslide("onkeypress");break;case="" kkeycode_delete:b="true;if(this.accumulatingDigits){if(this.digitAccumulator<10){if(this.slideNumberTimeout){clearTimeout(this.slideNumberTimeout)}this.slideNumberTimeout=setTimeout(this.hideAndResetSlideNumberController.bind(this),0)}else{if(this.slideNumberTimeout){clearTimeout(this.slideNumberTimeout)}this.slideNumberTimeout=setTimeout(this.hideAndResetSlideNumberController.bind(this),7000);var" d="this.digitAccumulator.toString();this.digitAccumulator=parseInt(d.substring(0,d.length-1));this.slideNumberController.setSlideNumber(this.digitAccumulator)}}break;case" kkeycode_home:if(this.script.showmode!="kShowModeHyperlinksOnly){this.jumpToSlide(1)}else{debugMessage(kDebugShowController_OnKeyPress,"-" mode")}break;case="" kkeycode_end:if(this.script.showmode!="kShowModeHyperlinksOnly){this.jumpToSlide(this.script.slideCount)}else{debugMessage(kDebugShowController_OnKeyPress,"-" mode")}break;default:if(this.slidenumbertimeout){cleartimeout(this.slidenumbertimeout)}this.slidenumbertimeout="setTimeout(this.hideAndResetSlideNumberController.bind(this),7000);if((c">=kKeyCode_0)&&(c<=kkeycode_9)){if(this.slidenumberdisplay.isshowing){this.slidenumberdisplay.hide()}b=true;if(this.accumulatingdigits===false){this.accumulatingdigits=true;this.digitaccumulator=0}if(this.digitaccumulator.tostring().length<4){this.digitaccumulator*=10;this.digitaccumulator+=(c-kkeycode_0);this.slidenumbercontroller.setslidenumber(this.digitaccumulator);if(!this.slidenumbercontroller.isshowing){this.slidenumbercontroller.show()}}}else{b=true}break}if(this.accumulatingdigits&&(b===false)){}},hideandresetslidenumbercontroller:function(){if(this.slidenumbertimeout){cleartimeout(this.slidenumbertimeout)}this.accumulatingdigits=false;this.digitaccumulator=0;this.slidenumbercontroller.hide()},hideslidenumberdisplay:function(){this.slidenumberdisplay.hide()},togglefullscreen:function(){if(isie){return}settimeout((function(){this.displaymanager.stagearea.style.opacity=0}).bind(this),0);this.displaymanager.hidehud(true);if(document.webkitisfullscreen||document.mozfullscreen){this.isfullscreen=false;(document.webkitcancelfullscreen&&document.webkitcancelfullscreen())||(document.mozcancelfullscreen&&document.mozcancelfullscreen())}else{this.isfullscreen=true;(document.body.webkitrequestfullscreen&&document.body.webkitrequestfullscreen())||(document.body.mozrequestfullscreen&&document.body.mozrequestfullscreen())}},changestate:function(a){if(a!=this.state){this.leavingstate();this.state=a;this.enteringstate()}},leavingstate:function(){switch(this.state){case kshowcontrollerstate_stopped:break;case="" kshowcontrollerstate_starting:break;case="" kshowcontrollerstate_settingupscene:break;case="" kshowcontrollerstate_idleatfinalstate:break;case="" kshowcontrollerstate_idleatinitialstate:break;case="" kshowcontrollerstate_waitingtojump:break;case="" kshowcontrollerstate_readytojump:break;case="" kshowcontrollerstate_waitingtoplay:this.displaymanager.hidewaitingindicator();break;case="" kshowcontrollerstate_readytoplay:break;case="" kshowcontrollerstate_playing:break}},enteringstate:function(){switch(this.state){case="" kshowcontrollerstate_starting:this.displaymanager.showwaitingindicator();break;case="" kshowcontrollerstate_idleatfinalstate:case="" kshowcontrollerstate_idleatinitialstate:this.updateslidenumber();this.displaymanager.hidewaitingindicator();this.createhyperlinksforcurrentstate("idle");runinnexteventloop(this.doidleprocessing.bind(this));break;case="" kshowcontrollerstate_waitingtoplay:this.displaymanager.showwaitingindicator();break;case="" kshowcontrollerstate_playing:break}},doidleprocessing:function(){this.preloadappropriatescenes();if(this.queueduseraction!="null){this.queuedUserAction();this.queuedUserAction=null}else{var" a="this.stageManager.stage;if(a.childNodes.length!=0){this.updateNavigationButtons()}else{}}},truncatedSlideIndex:function(a){return" this.truncatedindex(a,this.script.lastslideindex,this.script.loopslideshow)},truncatedsceneindex:function(a){return="" this.truncatedindex(a,this.script.lastsceneindex,this.script.loopslideshow)},truncatedindex:function(a,c,b){if(a<0){if(b){a="a+c+1}else{a=-1}}else{if(a">c){if(b){a=a-c-1}else{a=-1}}}return a},preloadAppropriateScenes:function(){var d=this.currentSceneIndex;if(this.state===kShowControllerState_IdleAtFinalState){d++}var a=this.script.slideIndexFromSceneIndexLookup[d];var e=this.scriptManager.sceneIndexFromSlideIndex(this.truncatedSlideIndex(a-1));var b=this.scriptManager.sceneIndexFromSlideIndex(this.truncatedSlideIndex(a-2));var p=this.scriptManager.sceneIndexFromSlideIndex(this.truncatedSlideIndex(a-3));var g=this.truncatedSceneIndex(d-1);var f=this.truncatedSceneIndex(d-2);var c=this.truncatedSceneIndex(d-3);var n=this.truncatedSceneIndex(d+1);var m=this.truncatedSceneIndex(d+2);var k=this.truncatedSceneIndex(d+3);var l=this.scriptManager.sceneIndexFromSlideIndex(this.truncatedSlideIndex(a+1));var j=this.scriptManager.sceneIndexFromSlideIndex(this.truncatedSlideIndex(a+2));var i=this.scriptManager.sceneIndexFromSlideIndex(this.truncatedSlideIndex(a+3));var o={};var h=(gIpad===true);if(!h&&p!=-1){o[p]=true}if(!h&&b!=-1){o[b]=true}if(!h&&e!=-1){o[e]=true}if(!h&&c!=-1){o[c]=true}if(!h&&f!=-1){o[f]=true}if(!h&&g!=-1){o[g]=true}o[this.currentSceneIndex]=true;o[d]=true;if(n!=-1){o[n]=true}if(!h&&m!=-1){o[m]=true}if(!h&&k!=-1){o[k]=true}if(!h&&l!=-1){o[l]=true}if(!h&&j!=-1){o[j]=true}if(!h&&i!=-1){o[i]=true}this.textureManager.preloadScenes(o)},advanceToNextBuild:function(b){if(!this.script){return false}if(this.script.showMode===kShowModeHyperlinksOnly&&b!="currentSceneDidComplete"){return false}if(this.displayManager.infoPanelIsShowing){return false}var a=false;switch(this.state){case kShowControllerState_IdleAtFinalState:if(this.nextSceneIndex===-1){if(this.delegate.getKPFJsonStringForShow){this.stopSoundTrack();this.exitShow()}else{this.stopSoundTrack();break}}a=true;this.jumpToScene(this.nextSceneIndex,true);break;case kShowControllerState_IdleAtInitialState:if(this.currentSceneIndex>=this.script.numScenes){if(this.script.loopSlideshow){a=true;this.jumpToScene(0,false)}else{if(this.delegate.getKPFJsonStringForShow){this.stopSoundTrack();this.exitShow()}else{this.stopSoundTrack();break}}}else{a=true;this.playCurrentScene()}break;default:debugMessage(kDebugShowController_AdvanceToNextBuild,"nextSceneIndex: "+this.nextSceneIndex+" can't advance now, not in an idle state (currently in '"+this.state+"' state), queue up action to run in next idle time");if(this.queuedUserAction==null){a=true;this.queuedUserAction=this.advanceToNextBuild.bind(this,b)}break}return a},advanceToNextSlide:function(d){if(!this.script){return false}if(this.script.showMode==kShowModeHyperlinksOnly){return}if(this.displayManager.infoPanelIsShowing){return}var b=this.currentSceneIndex;switch(this.state){case kShowControllerState_IdleAtFinalState:b=b+1;case kShowControllerState_IdleAtInitialState:var f=this.scriptManager.slideIndexFromSceneIndex(b);var c;if(f===this.script.slideCount-1){if(this.script.loopSlideshow){c=0}else{return}}else{c=this.currentSlideIndex+1}var g=this.scriptManager.sceneIndexFromSlideIndex(c);var e=this.script.events[g];var a=e.automaticPlay==1||e.automaticPlay==true;this.jumpToSlide(c+1,a);break;default:debugMessage(kDebugShowController_AdvanceToNextSlide,"can't advance now, not in an idle state (currently in '"+this.state+"' state), queue up action to run in next idle time");if(this.queuedUserAction==null){this.queuedUserAction=this.advanceToNextSlide.bind(this,d)}break}},goBackToPreviousBuild:function(c){if(!this.script){return false}this.resetMediaCache();if(this.script.showMode==kShowModeHyperlinksOnly){return}if(this.displayManager.infoPanelIsShowing){return}var a=this.currentSceneIndex;switch(this.state){case kShowControllerState_IdleAtFinalState:a=a+1;case kShowControllerState_Playing:case kShowControllerState_IdleAtInitialState:var b;if(a===0){if(this.script.loopSlideshow){b=this.script.events.length-1}else{return}}else{b=a-1}this.jumpToScene(b,false);break;default:debugMessage(kDebugShowController_GoBackToPreviousBuild,"can't go back now, not in an idle state (currently in '"+this.state+"' state)");if(this.queuedUserAction==null){this.queuedUserAction=this.goBackToPreviousBuild.bind(this,c)}break}},goBackToPreviousSlide:function(c){if(!this.script){return false}if(this.script.showMode==kShowModeHyperlinksOnly){return}if(this.displayManager.infoPanelIsShowing){return}var b=this.currentSceneIndex;switch(this.state){case kShowControllerState_IdleAtFinalState:b=b+1;case kShowControllerState_Playing:case kShowControllerState_IdleAtInitialState:var d=this.scriptManager.slideIndexFromSceneIndex(b);var a;if(d===0){if(this.script.loopSlideshow){a=this.script.slideCount-1}else{a=0}}else{if(d===-1&&b>0){a=this.script.slideCount-1}else{a=this.currentSlideIndex-1}}this.jumpToSlide(a+1);break;default:debugMessage(kDebugShowController_GoBackToPreviousSlide,"can't go back now, not in an idle state (currently in '"+this.state+"' state)");if(this.queuedUserAction==null){this.queuedUserAction=this.goBackToPreviousSlide.bind(this,c)}break}},calculatePreviousSceneIndex:function(a){if(a==-1){previousSceneIndex=-1}else{previousSceneIndex=a-1}return previousSceneIndex},jumpToSlide:function(b,a){var c=b-1;var d=this.scriptManager.sceneIndexFromSlideIndex(c);this.resetMediaCache();if(a==null){a=false}this.jumpToScene(d,a)},jumpToScene:function(d,c){this.lastSlideViewedIndex=this.scriptManager.slideIndexFromSceneIndex(this.currentSceneIndex);if(d===-1){return}switch(this.state){case kShowControllerState_Starting:var b="position:absolute;background-color:transparent; left:0px; top:0px; width:"+this.displayManager.usableDisplayWidth+"px; height:"+this.displayManager.usableDisplayHeight+"px;";this.starting=true;this.maskElement=document.createElement("div");this.maskElement.setAttribute("style",b);document.body.appendChild(this.maskElement);case kShowControllerState_IdleAtInitialState:case kShowControllerState_IdleAtFinalState:case kShowControllerState_ReadyToJump:break;default:debugMessage(kDebugShowController_JumpToScene,"can't jump now, currently in '"+this.state+"' state which does not supports jumping...");return}if(this.textureManager.isScenePreloaded(d)===false){this.changeState(kShowControllerState_WaitingToJump);var a={sceneIndex:d,automaticPlay:c};this.waitForSceneToLoadTimeout=setTimeout(this.handleSceneDidNotLoad.bind(this,a),kMaxSceneDownloadWaitTime);this.textureManager.loadScene(d,this.handleSceneDidLoad.bind(this,a));return}this.changeState(kShowControllerState_SettingUpScene);runInNextEventLoop(this.jumpToScene_partThree.bind(this,d,c))},handleSceneDidLoad:function(a){clearTimeout(this.waitForSceneToLoadTimeout);this.displayManager.setNextButtonEnabled(this.currentSceneIndex<(this.script.pagecount-1));switch(this.state){case kshowcontrollerstate_waitingtojump:this.changestate(kshowcontrollerstate_readytojump);this.jumptoscene_parttwo(a.sceneindex,a.automaticplay);break;default:break}},handlescenedidnotload:function(a){cleartimeout(this.waitforscenetoloadtimeout);this.queueduseraction="null;var" b="this.promptUserToTryAgain(kUnableToReachiWorkTryAgain);if(b){var" d="window.location.href;var" f;var="" e="d.indexOf("&restartingSceneIndex");if(e===-1){f=d}else{f=d.substring(0,e)}var" c="f+"&restartingSceneIndex="+a.sceneIndex;window.location.replace(c)}else{this.changeState(kShowControllerState_IdleAtFinalState)}},jumpToScene_partTwo:function(b,a){this.changeState(kShowControllerState_SettingUpScene);runInNextEventLoop(this.jumpToScene_partThree.bind(this,b,a))},jumpToScene_partThree:function(c,a){var" a="this.script;if(a.showMode===kShowModeAutoplay){var">0){var b=c[0].type==="transition"?a.autoplayTransitionDelay:a.autoplayBuildDelay;setTimeout((function(){this.playCurrentScene()}).bind(this),b*1000)}else{this.playCurrentScene()}}else{this.playCurrentScene()}}else{this.changeState(kShowControllerState_IdleAtInitialState);if(this.isRecording&&!this.isRecordingStarted){this.narrationManager.start();this.isRecordingStarted=true}}},displayScene:function(g,b){if(g===-1){return}this.animationManager.deleteAllAnimations();var c=this.scriptManager.slideIndexFromSceneIndex(this.currentSceneIndex);var e=b?b.slideIndex:this.scriptManager.slideIndexFromSceneIndex(g);if(c!==e){this.resetMediaCache()}this.setCurrentSceneIndexTo(g);if(b){this.playbackController.renderEvent(b)}else{var f=this.script.slideIndexFromSceneIndexLookup[g];var d=this.script.slideList[f];var a=new KPFEvent({slideId:d,slideIndex:f,sceneIndex:g,event:this.script.events[g],animationSupported:this.animationSupported});this.playbackController.renderEvent(a)}this.updateNavigationButtons()},setCurrentSceneIndexTo:function(a){this.currentSceneIndex=a;this.assignNextSceneIndex();this.updateSlideNumber();this.updateNavigationButtons()},assignNextSceneIndex:function(){this.nextSceneIndex=this.calculateNextSceneIndex(this.currentSceneIndex)},calculateNextSceneIndex:function(b){var a=this.calculateNextSceneIndex_internal(b);return a},calculateNextSceneIndex_internal:function(b){var a=-1;if(b<this.script.lastsceneindex){a=b+1}else{if(this.script.loopslideshow){a=0}else{a=-1}}return a},updateslidenumber:function(){var="" b="this.currentSceneIndex;if(this.state===kShowControllerState_IdleAtFinalState){b=this.nextSceneIndex}var" a="this.scriptManager.slideIndexFromSceneIndex(b);if(this.firstSlide){runInNextEventLoop((function(){this.startSoundTrack();this.displayManager.clearLaunchMode()}).bind(this));this.firstSlide=false}if(this.currentSlideIndex!=a){this.previousSlideIndex=this.currentSlideIndex;this.currentSlideIndex=a;this.displayManager.updateSlideNumber(this.currentSlideIndex+1,this.script.slideCount);this.delegate.propertyChanged(kPropertyName_currentSlide,this.currentSlideIndex+1);document.fire(kSlideIndexDidChangeEvent,{slideIndex:this.currentSlideIndex})}},updateNavigationButtons:function(){var" c="this.currentSceneIndex;if(this.state===kShowControllerState_IdleAtFinalState){c++}this.updateWindowHistory(c);var">0){a=true}if(c===0&&this.script.lastSceneIndex===0){b=true}else{if(this.currentSceneIndex<this.script.lastsceneindex){b=true}else{if(this.currentsceneindex===this.script.lastsceneindex){if(this.state===kshowcontrollerstate_idleatinitialstate){b=true}else{b=false}}else{b=false}}}}}this.displaymanager.setpreviousbuttonenabled(a);this.displaymanager.setnextbuttonenabled(b)},playcurrentscene:function(b){var h="this.state;var" j;var="" e="0;var" d="this.playbackController.eventOverallEndTime();this.changeState(kShowControllerState_Playing);if(this.helpPlacard.isShowing){this.helpPlacard.hide()}if(this.slideNumberDisplay.isShowing){this.slideNumberDisplay.hide()}if(b){j=b.sceneIndexToJump;this.resetMediaCache()}else{j=this.nextSceneIndex;var" g="this.scriptManager.slideIndexFromSceneIndex(this.currentSceneIndex);var" c="this.scriptManager.slideIndexFromSceneIndex(j);if(g!==c){this.resetMediaCache()}if(this.playbackController.kpfEvent.event.automaticPlay==true&&this.playbackController.kpfEvent.event.effects[0].type==="transition"){e=this.playbackController.kpfEvent.event.effects[0].beginTime;d=this.playbackController.kpfEvent.event.effects[0].duration}}if(this.animationSupported){clearTimeout(this.animateTimeout);var" a="this.playbackController.kpfEvent.event.effects;if(a.length===0){this.animateTimeout=setTimeout((function(){setTimeout(this.currentSceneDidComplete.bind(this,j),d*1000+100)}).bind(this),e*1000)}else{var" i;if(a[0].type="=="transition"){if(isIE||isEdge){i=this.playbackController.renderEffects()}else{if(a[0].name!="com.apple.iWork.Keynote.BLTBlinds"){i=this.playbackController.renderEffects()}}}this.animateTimeout=setTimeout((function(k){if(k==null){k=this.playbackController.renderEffects()}this.playbackController.animateEffects(k);setTimeout(this.currentSceneDidComplete.bind(this,j),d*1000+100)}).bind(this,i),e*1000)}}else{var" f="this.script.events[this.currentSceneIndex].automaticPlay;if(j===-1){this.updateNavigationButtons();if(this.delegate.getKPFJsonStringForShow){if(f){setTimeout(this.exitShow.bind(this),2000)}else{this.exitShow()}}else{this.changeState(kShowControllerState_IdleAtInitialState)}}else{if(f){setTimeout((function(){this.changeState(kShowControllerState_IdleAtInitialState);this.jumpToScene(j,this.script.events[j].automaticPlay)}).bind(this),2000)}else{this.changeState(kShowControllerState_IdleAtInitialState);setTimeout(this.jumpToScene.bind(this,j,this.script.events[j].automaticPlay),100)}}}},currentSceneDidComplete:function(c){var" b="this.script;var" in="" this.moviecache){delete="" this.moviecache[a].videoelement;delete="" this.moviecache[a]}this.moviecache="null},resetAudioCache:function(){for(var" this.audiocache){this.audiocache[a].pause();this.audiocache[a].src="" ;delete="" this.audiocache[a]}this.audiocache="null},updateWindowHistory:function(c){if(typeof(window.history.replaceState)!="undefined"){var" audio();this.soundtrackplayer.src="../" +a;this.soundtrackplayer.volume="this.script.soundtrack.volume;this.soundTrackPlayer.observe("ended",this.soundTrackItemDidComplete.bind(this),false);this.soundTrackPlayer.load();this.soundTrackPlayer.play()},soundTrackItemDidComplete:function(){this.currentSoundTrackIndex++;if(this.currentSoundTrackIndex<this.script.soundtrack.tracks.length){this.playNextItemInSoundTrack()}else{if(this.script.soundtrack.mode===kSoundTrackModePlayOnce){this.soundTrackPlayer=null}else{if(this.script.soundtrack.mode===kSoundTrackModeLooping){this.startSoundTrack()}}}},processHyperlink:function(k){var" m;if(d.indexof("?slide=")===0){var l=d.substring(7);var g=-1;if(l===" first"){g="0}else{if(l==="last"){g=this.script.slideCount-1}else{var" kshowcontrollerstate_idleatfinalstate:b="b+1;case" kshowcontrollerstate_idleatinitialstate:var="" j="d.substring(9);var" k="l.events;var" kshowcontrollerstate_idleatfinalstate:if(g<this.script.numscenes-1){g="g+1}else{if(this.script.loopSlideshow){g=0}}case" i="new" kpfevent({slideid:a,slideindex:c,sceneindex:g,event:e,animationsupported:this.animationsupported});this.displayscene(g,i);this.playcurrentscene({sceneindextojump:j});break;default:return}}else{var="" this.moviehyperlinks;this.moviehyperlinks="new" array()},clearallhyperlinks:function(){this.stagemanager.clearallhyperlinks();delete="" this.activehyperlinks;this.activehyperlinks="new" array()},findhyperlinkatcoords:function(b){var="">0;d--){var e=this.activeHyperlinks[d-1];var c=e.targetRectangle;hyperlinkLeft=Math.floor(c.x);hyperlinkTop=Math.floor(c.y);hyperlinkRight=hyperlinkLeft+Math.floor(c.width);hyperlinkBottom=hyperlinkTop+Math.floor(c.height);if((b.pointX>=hyperlinkLeft)&&(b.pointX<=hyperlinkright)&&(b.pointy>=hyperlinkTop)&&(b.pointY<=hyperlinkbottom)){return e}}return="" null},createhyperlinksforcurrentstate:function(a){var="" b="-1;switch(this.state){case" kshowcontrollerstate_idleatinitialstate:b="this.currentSceneIndex;break;case" kshowcontrollerstate_idleatfinalstate:if(this.currentsceneindex<this.script.lastsceneindex){b="this.currentSceneIndex+1}else{if(this.script.showMode==kShowModeHyperlinksOnly){b=this.currentSceneIndex}else{if(this.script.loopSlideshow){b=0}}}break;default:break}if(b!=-1){this.clearAllHyperlinks();this.createHyperlinks(b)}},createHyperlinks:function(l){if(l===-1){return}var" m="this.script.events[l];if(m==null){return}var" g="m.hyperlinks;if(g==null){return}var" p="g.length;var" j;var="" v="50;var" d="this.displayManager.showWidth;var" k="this.displayManager.showHeight;for(j=0;j<p;j++){var" f="g[j];var" u="f.targetRectangle;var" r="{targetRectangle:u,events:f.events,url:f.url};var" t="u.x;var" i="u.y;var" w="d-(u.x+u.width);var" o="k-(u.y+u.top);if(gMode===kModeMobile){if(u.width<b){var" q="b-u.width;var" c="q/2;var" e="q/2;if(t<c){c=t}else{if(w<e){c=c+(e-w)}}r.targetRectangle.x-=c;r.targetRectangle.width+=q}if(u.height<v){var" s="v-u.height;var" n="s/2;var" h="s/2;if(i<n){n=i}else{if(o<h){n=n+(e-w)}}r.targetRectangle.y-=n;r.targetRectangle.height+=s}}this.stageManager.addHyperlink(r.targetRectangle);this.activeHyperlinks[j]=r}if(this.movieHyperlinks.length">0){for(var a=0;a</=hyperlinkbottom)){return></=hyperlinkright)&&(b.pointy></this.script.lastsceneindex){b=true}else{if(this.currentsceneindex===this.script.lastsceneindex){if(this.state===kshowcontrollerstate_idleatinitialstate){b=true}else{b=false}}else{b=false}}}}}this.displaymanager.setpreviousbuttonenabled(a);this.displaymanager.setnextbuttonenabled(b)},playcurrentscene:function(b){var></this.script.lastsceneindex){a=b+1}else{if(this.script.loopslideshow){a=0}else{a=-1}}return></(this.script.pagecount-1));switch(this.state){case></=kkeycode_9)){if(this.slidenumberdisplay.isshowing){this.slidenumberdisplay.hide()}b=true;if(this.accumulatingdigits===false){this.accumulatingdigits=true;this.digitaccumulator=0}if(this.digitaccumulator.tostring().length<4){this.digitaccumulator*=10;this.digitaccumulator+=(c-kkeycode_0);this.slidenumbercontroller.setslidenumber(this.digitaccumulator);if(!this.slidenumbercontroller.isshowing){this.slidenumbercontroller.show()}}}else{b=true}break}if(this.accumulatingdigits&&(b===false)){}},hideandresetslidenumbercontroller:function(){if(this.slidenumbertimeout){cleartimeout(this.slidenumbertimeout)}this.accumulatingdigits=false;this.digitaccumulator=0;this.slidenumbercontroller.hide()},hideslidenumberdisplay:function(){this.slidenumberdisplay.hide()},togglefullscreen:function(){if(isie){return}settimeout((function(){this.displaymanager.stagearea.style.opacity=0}).bind(this),0);this.displaymanager.hidehud(true);if(document.webkitisfullscreen||document.mozfullscreen){this.isfullscreen=false;(document.webkitcancelfullscreen&&document.webkitcancelfullscreen())||(document.mozcancelfullscreen&&document.mozcancelfullscreen())}else{this.isfullscreen=true;(document.body.webkitrequestfullscreen&&document.body.webkitrequestfullscreen())||(document.body.mozrequestfullscreen&&document.body.mozrequestfullscreen())}},changestate:function(a){if(a!=this.state){this.leavingstate();this.state=a;this.enteringstate()}},leavingstate:function(){switch(this.state){case></1){this.digitaccumulator=1}}this.slidenumbercontroller.setslidenumber(this.digitaccumulator);this.jumptoslide(this.digitaccumulator)}else{debugmessage(kdebugshowcontroller_onkeypress,"-></=kkeycode_numeric_9)){c=kkeycode_0+(c-kkeycode_numeric_0)}c+=(a.shiftkey?kkeymodifier_shift:0);c+=(a.altkey?kkeymodifier_alt:0);c+=(a.ctrlkey?kkeymodifier_ctrl:0);c+=(a.metakey?kkeymodifier_meta:0);if(this.isrecording){return}var></this.script.numscenes-1){a=this.currentsceneindex+1}else{if(this.script.loopslideshow){a=0}}}this.jumptoscene(a,false)}document.fire(kshowsizedidchangeevent,{width:this.script.slidewidth,height:this.script.slideheight})},handlestagesizedidchangeevent:function(a){this.touchcontroller.settrackarea(a.memo.left,a.memo.top,a.memo.width,a.memo.height)},handlekeydownevent:function(c){var></10){this.animationsupported=false}else{this.animationsupported=true}document.observe("contextmenu",this.handlecontextmenuevent.bind(this));event.observe(this.displaymanager.previousbutton,"click",this.gobacktopreviousslide.bind(this,"tappreviousbutton"));event.observe(this.displaymanager.nextbutton,"click",this.advancetonextbuild.bind(this,"tapnextbutton"))},startshow:function(){this.changestate(kshowcontrollerstate_downloadingscript);this.scriptmanager.downloadscript(this.delegate)},exitshow:function(a){cleartimeout(this.exittimeout);if(a){this.delegate.showexited()}else{this.exittimeout=settimeout((function(){this.delegate.showexited()}).bind(this),750)}},promptusertotryagain:function(b){var>